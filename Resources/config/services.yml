services:

    bootcamp.init.autoroute:
        class: Netgusto\AutorouteBundle\Routing\AutorouteProvider
        arguments:
            - @='@NetgustoBootCampBundle/Resources/config/routes/init.yml'
        tags:
            - { name: autoroute.provider, prefix: '/_init'}

    bootcamp.systemhealth:
        class: Netgusto\BootCampBundle\EventListener\SystemHealthCheckerListener
        arguments:
            # Event listener are not lazyloaded, so need to inject service container to still lazyload @system.status
            - @service_container
            - @environment
            - @database_connection
            # LAZYLOADED # - @system.status
        tags:
            - { name: kernel.event_listener, event: kernel.request, method: onKernelRequest }

    bootcamp.exceptionlistener:
        class: Netgusto\BootCampBundle\EventListener\InitializationExceptionListener
        scope: request
        arguments:
            # Event listener are not lazyloaded, so need to inject service container to still lazyload @initialization.controller
            - @service_container
            - @environment
            - @request
            # LAZYLOADED # - @database_connection
            # LAZYLOADED # - @initialization.controller
        tags:
            - { name: kernel.event_listener, event: kernel.exception, method: onKernelException }

    scalar.interpreter:
        class: Netgusto\BootCampBundle\Services\ScalarInterpreterService

    environment:
        class: Netgusto\BootCampBundle\Services\Context\EnvironmentService
        arguments:
            - %environment_resolved%
            - @scalar.interpreter
            - %kernel.root_dir%

    system.status:
        class: Netgusto\BootCampBundle\Services\Context\SystemStatusService
        arguments:
            - @doctrine.orm.entity_manager

    twig.pulpyextension:
        class: Netgusto\BootCampBundle\Twig\BootCampExtension
        arguments:
            # Inject service container to lazyload dependencies
            - @service_container
        tags:
            - { name: twig.extension }

    config.loader.dbbacked:
        class: Netgusto\BootCampBundle\Services\Config\Loader\DbBackedConfigLoaderService
        arguments:
            - @doctrine.orm.entity_manager
            - { data.dir: '' }

    config.site:
        class: %bootcamp.initconfig.class%
        arguments:
            - @=service('config.loader.dbbacked').load('config.site')

    initialization.controller:
        class: Netgusto\BootCampBundle\Controller\InitializationController
        lazy: true
        arguments:
            # To disable the profiler bar if defined
            - @service_container
            - @twig
            - @environment
            - @router
            - @form.factory
            - @security.encoder_factory
            - @system.status

            # LAZYLOADED # - @doctrine.orm.entity_manager